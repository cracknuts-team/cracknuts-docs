# 相关系数在侧信道分析中的作用

侧信道分析（SCA）通过采集设备运行时泄露的物理信息（如功耗、电磁辐射等）来破解密钥。在这一过程中，**相关系数**作为核心统计工具，能够量化物理信息与攻击者预测模型之间的**线性关联强度**，是实现攻击的关键。

---

## 核心作用

1. **泄露点定位**：通过**逐时间点**计算实测物理信息（如功耗）与预测模型值的相关系数，可识别出能量轨迹中与敏感操作（如明密文数据传输）高度相关的时刻。
2. **密钥区分**：遍历所有可能密钥猜测值，**只有正确密钥**的预测模型会在真实泄露点产生显著相关系数峰值，从而从大量错误密钥中脱颖而出。

----

## 关键概念

### 芯片功耗

加密芯片主要由CMOS（互补金属氧化物半导体）门电路构成，其功耗可表示为四部分：
$$
P(t) = \underbrace{P_{data}(t)}_{密钥相关} + \underbrace{P_{dyn}(t) + P_{stat}(t) + P_{noise}(t)}_{密钥无关}
$$

- $P(t)$：芯片运行产生的总功耗。
- $P_{data}(t)$：**目标数据操作**产生的功耗，**同密钥信息强相关**。
- $P_{stat}(t)$：芯片静态功耗。
- $P_{noise}(t)$：功耗噪音。
- $t$：时间点。

#### 数据功耗 ($P_{data}$)

$P_{data}(t)$为**目标数据操作**（如密钥运算）相关功耗，这里需先介绍两个重要概念：

- **汉明重量（Hamming Weight, HW）**： 指一个二进制数中 `1` **的个数**。
  - **公式**：对于 $b$ 位数据 $D$， $HW(D) = \sum_{i=0}^{b-1} D[i] \quad \text{（其中 } D[i] \text{ 是第 } i \text{ 位的值，取 0 或 1）}$ ，其物理意义是在芯片中，数据从状态 $0$ 翻转到 $1$ 的比特位数。
  - **示例**：数据 `0x37`（二进制 `00110111`），$HW = 5$。
- **汉明距离（Hamming Distance, HD）**： 指两个等长二进制数之间**不同位的数量**（即异或结果中 `1` 的个数）。 
  - **公式**：对于 $b$ 位数据 $D_1, D_2$， $HD(D_1, D_2) = HW(D_1 \oplus D_2)$ ，其物理意义是在芯片中，数据从状态 $D_1$ 翻转到 $D_2$ 时，电平变化的比特位数。
  -  **示例**：从 `0x21`（`00100001`）翻转到 `0x37`（`00110111`），$HD = HW(0x21 \oplus 0x37) = HW(0x16) = 3$。

**芯片功耗同芯片内部数据变化存在明显相关性。**

1. 当数据与功耗满足**汉明距离**模型关系时：

$$
P_{data}(t) = \epsilon \cdot HW(D)(t) + n(t)
$$

- $\epsilon$：**功耗系数**（单位：功耗/比特），反映单位比特翻转的功耗贡献。
- $\text{HW}(D)(t)$：在时刻$t$数据 $D$ 的**汉明重量**（即数据中比特 '1' 的数量）。
- $n(t)$：**噪声项**，包括电子噪声、时钟抖动、无关电路活动等。

 **适用场景：**

- 当目标操作（如寄存器加载、内存读取）的功耗主要取决于当前处理数据的比特值（如S盒输出）。
- **示例**：AES加密中S盒输出的汉明重量与功耗相关。



2. 当数据与功耗满足**汉明距离**模型关系时：

$$
P_{data}(t) = \epsilon \cdot HD(D_{\text{prev}}, D_{\text{curr}})(t) + n(t)
$$

- $\text{HD}(D_{\text{prev}}, D_{\text{curr}})(t)$：在时刻$t$的**汉明距离**（即前一状态 $D_{1}$ 到当前状态 $D_{2}$ 发生翻转的比特数）。
- 其他符号含义同上。

**适用场景：**

- 当功耗主要由电路状态**翻转（如寄存器、总线传输）** 引发时（CMOS电路的主要功耗源）。
- **示例**：DES/AES的轮寄存器更新、数据总线传输。



#### 动态功耗 ($P_{dyn}$)

$P_{dyn}$晶体管在开关过程中，对负载电容充放电造成的功耗，是芯片在运行程序时主要的功耗来源。这里需要强调，**$P_{dyn}$是同目标数据操作无关的功耗**。

$$
P_{dyn} = \alpha_t \cdot C_L \cdot V_{DD}^2 \cdot f + I_{sc} \cdot V_{DD} \cdot t_{sc}
$$
**1. 负载电容充放电功耗部分**

$\alpha_t \cdot C_L \cdot V_{DD}^2 \cdot f$

- $\alpha_t$：**活动因子**，单位时钟周期内，逻辑门或节点发生 0→1 或 1→0 翻转的概率（即信号翻转率）。
- $C_L$**：负载电容**，逻辑门输出端需要充放电的总电容
- $V_{DD}$：**电源电压**，芯片的供电电压。
- $f$：**时钟频率**，系统时钟的工作频率。

**2. 短路电流功耗部分**

$I_{\text{sc}} \cdot V_{DD} \cdot t_{\text{sc}}$

- $I_{\text{sc}}$：**短路电流**，在 **CMOS 逻辑门翻转瞬态** 期间，PMOS 和 NMOS **短暂同时导通**，形成从 $V_{DD}$ 到 GND 的低阻路径，产生的峰值电流。
- $t_{\text{sc}}$：**短路持续时间**，输入信号处于 $V_t < V_{\text{in}} < V_{DD} - V_t$ 区间的时间，即 PMOS 和 NMOS 同时导通的窗口。



#### **静态功耗 ($P_{stat}$)**

晶体管亚阈值漏电流/隧穿电流。这里需要强调，**$P_{stat}$是同目标数据操作无关的功耗**。

$P_{\text{stat}} = I_{\text{leak}} \cdot V_{DD}$

- $I_{leak}$：**漏电流**，主要由亚阈值漏电($I_{\text{sub}}$)、栅极隧穿($I_{\text{gat}}$)等组成



### 相关系数

皮尔逊相关系数量化两个变量 $P$（实测功耗信息）和 $Y$（预测模型值）的线性相关程度：
$$
\rho_{P, Y}(t) = \frac{\sum_{i=1}^{n} (P_i(t) - \bar{P}(t))(Y_i(t) - \bar{Y}(t))}{\sqrt{\sum_{i=1}^{n}(P_i(t) - \bar{P}(t))^2} \sqrt{\sum_{i=1}^{n}(Y_i(t) - \bar{Y}(t))^2}}
$$
其中：

- $P_i, Y_i$：第 $i$ 个样本的两个变量值

- $\bar{P} = \frac{1}{n}\sum_{i=1}^n P_i$ ：$P$的均值
- $\bar{Y} = \frac{1}{n}\sum_{i=1}^n Y_i$：$Y$的均值
- $\sigma_P$, $\sigma_Y$：$P$和$Y$的标准差
- $n$：样本数

**分子部分**： $\sum (P_i(t) - \bar{P}(t))(Y_i(t) - \bar{Y}(t))$

- 表示 $P$ 和 $Y$ 的**协方差**（未标准化），反映两变量的协同变化：

**分母部分**： $\sqrt{\sum (P_i(t) - \bar{P}(t))^2} \sqrt{\sum (Y_i(t) - \bar{Y}(t))^2}$

- 分别为 $P$ 和 $Y$ 的**标准差**的扩展形式（未除以 $n$），用于标准化协方差，使结果落在 $[-1, 1]$ 之间，**绝对值越接近 1 表示线性相关性越强**。

----

## 攻击示例—AES密钥破解

假设攻击目标为AES-128加密中的单字节密钥 $k$，功耗满足**汉明重量**模型，攻击流程分为两步：

### 步骤1：利用明/密文相关性确定加解密区间

**目标**：在长功耗曲线中定位加密操作发生的**时间范围**。 

1. 采集 $N$ 条加密过程的功耗曲线 $P_i(t)$（含明文输入 $p_i$ 和密文输出 $c_i$），对功耗曲线做对齐处理。

图（对齐曲线）

2. 对**每个时间点** $t$：

   - 用 **明文汉明重量** $HW(p_i)$ 作为预测模型 $Y_i^{\text{plain}}$。

   - 用 **密文汉明重量** $HW(c_i)$ 作为预测模型 $Y_i^{\text{cipher}}$。

   - 分别计算它们与功耗 $P_t = [P_1(t), P_2(t), ..., P_N(t)]$ 的相关系数 $\rho_{\text{plain}}(t)$ 和 $\rho_{\text{cipher}}(t)$。

3. **分析结果**：

   - 明文加载阶段：在功耗曲线**起始端**会出现 $\rho_{\text{plain}}(t)$ 的显著峰值（如 $t_{\text{load}}$）。

   - 密文输出阶段：在功耗曲线**结束端**会出现 $\rho_{\text{cipher}}(t)$ 的显著峰值（如 $t_{\text{out}}$）。

   - **加密核心区间**：位于 $t_{\text{load}}$ 与 $t_{\text{out}}$ 之间（图中红框）。


> ✅ **关键作用**：快速缩小分析范围，避免在全功耗曲线盲目计算密钥相关性。



明/密文相关性分析代码如下：

```python
from cracknuts_squirrel.correlation_analysis2 import CorrelationAnalysis, AnalysisParams
from cracknuts.jupyter.trace_panel import TracePanelWidget

dataset_name = 'dataset/aes.zarr/'
analyzer = CorrelationAnalysis(input_path=dataset_name)
analyzer.auto_out_filename()

result = analyzer.perform_analysis(AnalysisParams(data_type="plaintext"), AnalysisParams(data_type="ciphertext"))

tp = TracePanelWidget()
tp.set_numpy_data(result)
tp.show_all_trace()
tp
```

明/密文相关性分析结果如下图所示：

![echarts (27)](./.%E7%9B%B8%E5%85%B3%E7%B3%BB%E6%95%B0%E5%9C%A8%E4%BE%A7%E4%BF%A1%E9%81%93%E5%88%86%E6%9E%90%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8.assets/%E6%98%8E%E5%AF%86%E6%96%87%E7%9B%B8%E5%85%B3%E6%80%A7.png)

从分析结果可以看到明显的相关性。



### 步骤2：在核心区间内破解密钥

**目标**：在加密核心区间内定位密钥相关操作的泄露点，并破解 $k$。

1. **构建密钥相关模型**：
   - 猜测密钥字节 $kg$（0~255），对每条功耗计算中间值 $S(p_i \oplus kg)$ 的汉明重量（$S$ 为AES S盒）： $Y_i^{\text{Sbox}}(kg) = HW(S(p_i \oplus kg))$


2. **逐点计算相关系数**：
   - 对核心区间内**每个时间点** $t$ 和**每个** $kg$，计算功耗 $P_t$ 与 $Y^{\text{Sbox}}(kg)$ 的相关系数 $r(kg, t)$。


3. **识别正确密钥**：

   - 绘制所有 $kg$ 对应的相关迹（横轴：时间，纵轴：$|r(kg,t)|$）。

   - **错误密钥**：相关迹波动平缓（$|r| \approx 0$）。

   - **正确密钥** $k_{\text{correct}}$：在 S盒计算时刻 $t_{\text{Sbox}}$ 出现**显著尖峰**（如图中最高峰）。


图（密钥破解）

----

## 总结

相关系数在侧信道分析中扮演双重角色：

1. **区间定位器**：通过明/密文等已知数据与功耗的相关性，快速锁定加解密操作的时间窗口；
2. **密钥破解器**：在目标区间内，通过密钥猜测模型与功耗的峰值相关性，精准识别正确密钥。

其数学严谨性（皮尔逊公式）与对物理泄露机制（汉明重量/距离模型）的适配性，使其成为CPA等攻击的核心引擎。尽管机器学习等新方法兴起，相关系数因其直观性与高效性，仍是侧信道分析的重要工具。



## 附录

- 功耗曲线：

- 分析代码：
- NUT Golden固件